---
title: 첫 회사에서의 10개월 (1)
tags: [REVIEW]
author: 김태영
---

2022년 8월 29일, 지금 다니고 있는 회사에 입사했다.<br>
계산해보니 일을 시작한지 10개월이 되어간다. <br>
바쁘다는 핑계로 전혀 기록을 하지 않았다 <br>
블로그를 새로 시작하며 간략하게 지난 회사 생활을 정리해보려고 한다.

## Part 1. 2022.08.29 ~ 2022.09.30

첫 한달은 인수인계를 받으며 회사 코드를 이해하는데 사용했다.

회사는 한개의 모바일 어플을 운영중이었고, 추가적으로 어플 하나를 더 런칭할 준비를 하고 있다.

회사의 서비스는 공모주 청약 정보 제공 어플로 이를 일임 서비스로 발전시키는 것이 목표였다.

서버는 Node.js+Graphql 서버, Node.js로만 구성된 Assist 서버 두 개로, AWS Lambda로 배포되어있었다.
이 두 서버는 Hasura-Cloud에 배포되어있는 Hasura-Graphql-Engine과 연결된 상태였고, 어플의 프론트엔드는 이 Hasura 엔진의 Graphql API를 통해 데이터를 가져오는 구조였다.
회사의 백엔드 구성은 다음과 같았다.

#### 변경전 스펙

```js
- 서버
  - Node.js + Express
  - GraphQL
  - Hasura-Graphql-engine
- 배포
  - AWS Lambda
  - Serverless Framework
- 데이터베이스
  - PostgreSQL
  - RawSQL 사용중
- 데이터 크롤링 & 스크래핑
  - Python
```

Hasura와 Serverless Framework, PostgreSQL은 처음 접해보는 기술이었고, 파이썬 또한 생소했다.
일주일 동안은 이 것들을 공부하며 회사 코드를 전체적으로 훑어봤다.

그 다음주에 사수 개발자님께 nodejs 서버를 nestjs로 마이그레이션하는 것을 제안드렸고 고맙게도 흔쾌히 승락해주셨다.
나중에 이야기해보니 전부터 nestjs로 환경을 바꾸는 것을 고려하고 있었다고 한다.

#### 변경을 고려한 이유

- 코드 가독성 및 폴더 구조 개선
- 타입스크립트 사용 (물론 기존의 코드도 ts로 작성되어있긴 했다)
- nestjs의 내장 기능 사용
- graphql 호환

그런데 지금 생각해보면 그저 표면적인 이유들이었고, 변경하지 않아도 딱히 문제는 없던 상황이었다.

nodejs로 짜여진 서버코드는 정해진 규칙이 딱히 없어 사람마다 구조가 제각기다.
입사직전에 코드를 짤때는, nodejs 환경을 잠시 제쳐두고 nestjs로만 구축해보던 상황이었다.
그래서인지 회사코드를 봤을때, nestjs의 규격화된 구조와 다른점이 많았고 그 이질감이 굉장히 어색했다.

사수는 이미 굳이 필요하지 않은 작업이라는 것을 알고 있었다.
그럼에도 동의해주신 이유는 사실 기술적인 이유보다도 내가 레거시 코드와 친해질 가장 빠른 방법이며 가장 효율적인 방법이었기 때문이라고 했다.
실제로 코드와 빨리 친해질 수 있었고, 추후에 사수분이 퇴사하신 후에도 nestjs를 통해 편리하고 빠르게 새 피쳐들을 뽑아낼 수 있었다.

그렇게 한달간 nestjs로 마이그레이션하고, raw-sql로 작성되어있던 코드들을 typeorm을 통해 orm화했다. (물론 변경 불가능한 쿼리들도 많았다)

#### 변경된 스펙

```js
- 서버
  - Nest.js
    - exception filter 구현
    - pipe 구현
    - interceptor 구현
- 데이터베이스
  - TypeOrm 도입 및 복잡하지 않은 raw sql orm화
```

- 접해보지 못했던 서버리스 인프라 위에서 마이그레이션한다는 점에 어려움이 많았다
  - 로컬 테스트(serverless offline)와 배포 환경에서의 테스트의 차이가 존재했다. 따라서 손이 많이 갔다.
  - 마이그레이션 이후 확실히 nodejs-graphql보다 nestjs가 무겁게 돌아간다는 것을 체감했다
    - serverless-lambda는 늘 구동되는 방식이 아니라 요청이 들어올때만 구동되는 방식이다. 따라서 서버가 이니셜라이징 되는데 시간이 걸린다.
    - nestjs는 이 부분에서 느리게 이니셜라이징됨에 따라 배포 후에 처음 요청이 들어올때 시간이 걸리는 현상이 발생했다.
    - 이 문제를 위해 health check를 해주는 등의 조치를 취하긴 했지만, 어디까지나 임시방편이었다.
  - serverless로 모듈들을 번들링하는 과정에서 많은 오류가 발생했다. webpack 등을 사용해 호환성을 맞춰주는 과정이 필요했다. 결과적으로 호환시키며 구현을 완료했지만, sls의 번들링이 정확히 어떻게 작동하는지, 내가 세운 구조가 맞는지 고민하는 시간을 가지지 못했다.
  - `@nestjs/swagger`를 사용해 swagger를 띄울때, sls 환경에서는 swagger의 dto명을 읽지 못하고 해당 모듈 상의 제너릭 타입(ex. ProductDto => T )로 인식하는 문제가 발생했다. 아무래도 번들링 상의 문제인듯 보인다. 이 문제 때문에 swagger를 따로 띄울까도 생각했지만 새 피쳐를 곧바로 들어가야했으므로, 일단 추후에 해결하기로 했다.
